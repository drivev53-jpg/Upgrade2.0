<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Fox Chat AI</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            bg: '#ffffff',
                            darkBg: '#131314',
                            sidebar: '#f0f4f9',
                            darkSidebar: '#1e1f20',
                            userBubble: '#e3e3e3',
                            darkUserBubble: '#333537'
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        #loading {
            position: fixed; inset: 0; background-color: #ffffff; color: #1f2937;
            z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: ui-sans-serif, system-ui, sans-serif; transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        .dark #loading { background-color: #131314; color: #f3f4f6; }
        #loading.hidden-loader { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(0,0,0,0.1); border-top-color: #f97316;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem;
        }
        .dark .spinner { border: 4px solid rgba(255,255,255,0.1); border-top-color: #fb923c; }
        @keyframes spin { to { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .prose pre { background-color: #1f2937 !important; color: #e5e7eb !important; border-radius: 0.75rem; padding: 1rem; }
        .dark .prose pre { background-color: #000000 !important; border: 1px solid #374151; }
        
        .cursor-blink::after {
            content: 'â–‹'; display: inline-block; animation: blink 1s step-end infinite;
            margin-left: 2px; color: #f97316;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .dark .glass-panel { background: rgba(19, 19, 20, 0.9); backdrop-filter: blur(10px); }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gemini-bg dark:bg-gemini-darkBg text-gray-800 dark:text-gray-200 antialiased h-[100dvh] flex flex-col overflow-hidden">

    <div id="loading">
        <div class="spinner"></div>
        <div class="text-lg font-medium tracking-wide">Fox Chat is waking up...</div>
    </div>

    <div class="flex h-full w-full relative">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity"></div>

        <aside id="sidebar" class="w-72 bg-gemini-sidebar dark:bg-gemini-darkSidebar flex flex-col h-full absolute md:relative z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 border-r border-gray-200 dark:border-gray-800">
            <div class="p-4">
                <button id="btn-new-chat" class="w-full flex items-center justify-start gap-3 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm font-medium py-3 px-4 rounded-full shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
                    <i class="fa-solid fa-plus text-orange-500"></i> New Fox Chat
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-3 pb-4 space-y-1" id="chat-history-list"></div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-800">
                <button id="btn-open-settings" class="w-full flex items-center gap-3 hover:bg-gray-200 dark:hover:bg-gray-800 py-2 px-3 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-solid fa-gear w-5 text-center text-gray-400"></i> Settings
                </button>
                <button id="btn-open-system-prompt" class="w-full flex items-center gap-3 hover:bg-gray-200 dark:hover:bg-gray-800 py-2 px-3 rounded-lg text-sm font-medium transition-colors mt-1">
                    <i class="fa-solid fa-brain w-5 text-center text-gray-400"></i> Fox Brain
                </button>
                <div class="flex items-center justify-between px-3 py-2 mt-2">
                    <span class="text-sm font-medium">Dark Mode</span>
                    <button id="btn-theme-toggle" class="text-gray-500 hover:text-gray-800 dark:hover:text-white transition-colors">
                        <i class="fa-solid fa-moon text-xl"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full min-w-0 bg-gemini-bg dark:bg-gemini-darkBg relative">
            <header class="flex items-center justify-between p-4 glass-panel absolute top-0 w-full z-10 border-b md:border-none border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-3">
                    <button id="btn-toggle-sidebar" class="md:hidden text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 transition-colors">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <img src="https://t3.ftcdn.net/jpg/08/63/01/66/360_F_863016640_fdXeQ7Olm2XJv7BulETweOBaRlUg4lLL.jpg" alt="Fox Logo" class="w-8 h-8 rounded-lg object-cover shadow-sm">
                        <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-500 to-red-600">
                            Fox Chat
                        </h1>
                    </div>
                </div>
                <div class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded-md text-gray-500 dark:text-gray-400 max-w-[150px] truncate" id="current-model-display">
                    Model
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto px-4 md:px-24 pt-20 pb-6 flex flex-col gap-6 scroll-smooth">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center fade-in">
                    <div class="mb-6 relative">
                        <img src="https://t3.ftcdn.net/jpg/08/63/01/66/360_F_863016640_fdXeQ7Olm2XJv7BulETweOBaRlUg4lLL.jpg" alt="Fox Logo" class="w-24 h-24 rounded-3xl shadow-2xl border-4 border-white dark:border-gray-800 animate-pulse">
                    </div>
                    <h2 class="text-3xl md:text-4xl font-bold mb-2">Ready to chat, Ahmed?</h2>
                    <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto mb-8">Fox Chat is powered by OpenRouter. Enter your key in settings to begin your adventure.</p>
                </div>
            </div>

            <div class="p-4 md:px-24 pb-6 glass-panel z-10">
                <div class="relative max-w-4xl mx-auto flex items-end gap-2 bg-gray-100 dark:bg-gray-800 rounded-3xl p-2 border border-gray-200 dark:border-gray-700 focus-within:ring-2 focus-within:ring-orange-500/50 transition-all shadow-sm">
                    <textarea id="chat-input" rows="1" class="w-full bg-transparent border-none outline-none resize-none px-4 py-3 text-base placeholder-gray-500 dark:placeholder-gray-400" placeholder="Type a message..."></textarea>
                    <button id="btn-send" class="w-12 h-12 flex-shrink-0 rounded-full bg-orange-500 hover:bg-orange-600 text-white flex items-center justify-center transition-all shadow-md disabled:opacity-50">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
                <div class="text-center mt-2 text-[10px] text-gray-400 uppercase tracking-widest">
                    AI can make mistakes. Verify important info.
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-md shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-gear text-orange-500"></i> Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">OpenRouter API Key</label>
                    <input type="password" id="input-api-key" placeholder="sk-or-v1-..." class="w-full bg-gray-50 dark:bg-gray-800 border dark:border-gray-700 rounded-lg px-4 py-2 outline-none focus:border-orange-500 transition-colors">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Model ID</label>
                    <input type="text" id="input-model" placeholder="e.g., deepseek/deepseek-r1:free" class="w-full bg-gray-50 dark:bg-gray-800 border dark:border-gray-700 rounded-lg px-4 py-2 outline-none focus:border-orange-500">
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button class="close-modal px-4 py-2 text-sm">Cancel</button>
                    <button id="btn-save-settings" class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg transition-colors">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="system-prompt-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 rounded-2xl w-full max-w-lg shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-brain text-orange-500"></i> Fox Persona</h3>
            <textarea id="input-system-prompt" rows="6" class="w-full bg-gray-50 dark:bg-gray-800 border dark:border-gray-700 rounded-lg px-4 py-3 outline-none focus:border-orange-500 mb-4" placeholder="How should the fox behave?"></textarea>
            <div class="flex justify-end gap-3">
                <button class="close-modal px-4 py-2 text-sm">Cancel</button>
                <button id="btn-save-system-prompt" class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg transition-colors">Save Persona</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                chats: [],
                currentChatId: null,
                settings: { apiKey: '', model: 'deepseek/deepseek-r1:free', theme: 'dark' },
                systemPrompt: 'You are Fox Chat, a clever, helpful, and concise AI assistant.',
                isGenerating: false
            };

            let abortController = null;

            const els = {
                loading: document.getElementById('loading'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                chatHistoryList: document.getElementById('chat-history-list'),
                chatContainer: document.getElementById('chat-container'),
                welcomeScreen: document.getElementById('welcome-screen'),
                chatInput: document.getElementById('chat-input'),
                btnSend: document.getElementById('btn-send'),
                currentModelDisplay: document.getElementById('current-model-display'),
                settingsModal: document.getElementById('settings-modal'),
                systemPromptModal: document.getElementById('system-prompt-modal'),
                inputApiKey: document.getElementById('input-api-key'),
                inputModel: document.getElementById('input-model'),
                inputSystemPrompt: document.getElementById('input-system-prompt'),
                btnNewChat: document.getElementById('btn-new-chat'),
                btnToggleSidebar: document.getElementById('btn-toggle-sidebar'),
                btnOpenSettings: document.getElementById('btn-open-settings'),
                btnOpenSystemPrompt: document.getElementById('btn-open-system-prompt'),
                btnThemeToggle: document.getElementById('btn-theme-toggle'),
                btnSaveSettings: document.getElementById('btn-save-settings'),
                btnSaveSystemPrompt: document.getElementById('btn-save-system-prompt'),
                closeModalBtns: document.querySelectorAll('.close-modal')
            };

            function init() {
                loadState();
                applyTheme(state.settings.theme);
                els.currentModelDisplay.textContent = state.settings.model;
                if (state.chats.length === 0) { createNewChat(); } else {
                    if (!state.currentChatId) state.currentChatId = state.chats[0].id;
                    renderSidebar();
                    renderChat();
                }
                setupEventListeners();
                setTimeout(() => els.loading.classList.add('hidden-loader'), 400);
            }

            function loadState() {
                const c = localStorage.getItem('fox_chats'); if (c) state.chats = JSON.parse(c);
                const s = localStorage.getItem('fox_settings'); if (s) state.settings = { ...state.settings, ...JSON.parse(s) };
                const p = localStorage.getItem('fox_system_prompt'); if (p) state.systemPrompt = p;
                const id = localStorage.getItem('fox_current_id'); if (id) state.currentChatId = id;
            }

            function saveState() {
                localStorage.setItem('fox_chats', JSON.stringify(state.chats));
                localStorage.setItem('fox_settings', JSON.stringify(state.settings));
                localStorage.setItem('fox_system_prompt', state.systemPrompt);
                localStorage.setItem('fox_current_id', state.currentChatId);
            }

            function applyTheme(t) {
                document.documentElement.classList.toggle('dark', t === 'dark');
                els.btnThemeToggle.innerHTML = t === 'dark' ? '<i class="fa-solid fa-sun text-yellow-400 text-xl"></i>' : '<i class="fa-solid fa-moon text-xl"></i>';
            }

            function createNewChat() {
                const newChat = { id: Date.now().toString(36), title: 'New Conversation', messages: [], createdAt: Date.now() };
                state.chats.unshift(newChat);
                state.currentChatId = newChat.id;
                saveState();
                renderSidebar();
                renderChat();
            }

            function selectChat(id) {
                state.currentChatId = id;
                saveState();
                renderSidebar();
                renderChat();
                if (window.innerWidth < 768) {
                    els.sidebar.classList.add('-translate-x-full');
                    els.sidebarOverlay.classList.add('hidden');
                }
            }

            function renderSidebar() {
                els.chatHistoryList.innerHTML = '';
                state.chats.forEach(chat => {
                    const isActive = chat.id === state.currentChatId;
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-xl cursor-pointer text-sm truncate transition-all ${isActive ? 'bg-orange-500 text-white font-bold shadow-md' : 'hover:bg-gray-200 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400'}`;
                    div.onclick = () => selectChat(chat.id);
                    div.textContent = chat.title || 'Untitled Chat';
                    els.chatHistoryList.appendChild(div);
                });
            }

            function renderChat() {
                const chat = state.chats.find(c => c.id === state.currentChatId);
                els.chatContainer.innerHTML = '';
                if (!chat || chat.messages.length === 0) {
                    els.welcomeScreen.classList.remove('hidden');
                    els.chatContainer.appendChild(els.welcomeScreen);
                    return;
                }
                els.welcomeScreen.classList.add('hidden');
                chat.messages.forEach(msg => appendMessageUI(msg.role, msg.content));
                els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
            }

            async function copyToClipboard(text, btn) {
                await navigator.clipboard.writeText(text);
                const icon = btn.querySelector('i');
                icon.className = 'fa-solid fa-check text-green-500';
                setTimeout(() => icon.className = 'fa-regular fa-copy', 2000);
            }

            function appendMessageUI(role, content, isStreaming = false) {
                const wrapper = document.createElement('div');
                wrapper.className = `flex w-full group animate-fade-in ${role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const inner = document.createElement('div');
                if (role === 'user') {
                    inner.className = 'max-w-[85%] bg-orange-500 text-white px-5 py-3 rounded-2xl rounded-tr-sm shadow-sm font-medium';
                    inner.textContent = content;
                } else {
                    inner.className = 'max-w-[95%] md:max-w-[85%] flex gap-3 w-full';
                    inner.innerHTML = `
                        <img src="https://t3.ftcdn.net/jpg/08/63/01/66/360_F_863016640_fdXeQ7Olm2XJv7BulETweOBaRlUg4lLL.jpg" class="w-9 h-9 rounded-xl flex-shrink-0 shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex-1 overflow-hidden">
                            <div class="prose prose-orange dark:prose-invert max-w-none text-sm leading-relaxed ${isStreaming ? 'cursor-blink' : ''}">
                                ${marked.parse(content || '')}
                            </div>
                            <div class="flex items-center gap-3 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="btn-copy p-1 text-gray-400 hover:text-orange-500" title="Copy Message"><i class="fa-regular fa-copy text-xs"></i></button>
                            </div>
                        </div>
                    `;
                    const copyBtn = inner.querySelector('.btn-copy');
                    copyBtn.onclick = () => copyToClipboard(content, copyBtn);
                    wrapper.contentNode = inner.querySelector('.prose');
                }
                wrapper.appendChild(inner);
                els.chatContainer.appendChild(wrapper);
                els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
                return wrapper;
            }

            async function sendMessage() {
                const content = els.chatInput.value.trim();
                if (!content) return;

                if (state.isGenerating) {
                    if (abortController) abortController.abort();
                    return;
                }

                if (!state.settings.apiKey) { alert('Enter your OpenRouter API key in settings first!'); return; }

                els.chatInput.value = '';
                els.chatInput.style.height = 'auto';
                
                const chat = state.chats.find(c => c.id === state.currentChatId);
                if (chat.messages.length === 0) { chat.title = content.substring(0, 30); renderSidebar(); }
                
                chat.messages.push({ role: 'user', content });
                appendMessageUI('user', content);
                
                state.isGenerating = true;
                abortController = new AbortController();
                
                els.btnSend.innerHTML = '<i class="fa-solid fa-stop"></i>';
                els.btnSend.classList.replace('bg-orange-500', 'bg-red-500');

                const aiMsgDOM = appendMessageUI('assistant', '', true);
                let aiContent = "";

                try {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        signal: abortController.signal,
                        headers: { 'Authorization': `Bearer ${state.settings.apiKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: state.settings.model,
                            messages: [{ role: 'system', content: state.systemPrompt }, ...chat.messages],
                            stream: true
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    aiContent += data.choices[0]?.delta?.content || '';
                                    aiMsgDOM.contentNode.innerHTML = marked.parse(aiContent);
                                    els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
                                } catch(e) {}
                            }
                        }
                    }
                    chat.messages.push({ role: 'assistant', content: aiContent });
                    saveState();
                } catch (e) {
                    if (e.name === 'AbortError') aiMsgDOM.contentNode.innerHTML += ' <em class="text-xs text-red-500">(Stopped)</em>';
                } finally {
                    state.isGenerating = false;
                    abortController = null;
                    aiMsgDOM.contentNode.classList.remove('cursor-blink');
                    els.btnSend.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
                    els.btnSend.classList.replace('bg-red-500', 'bg-orange-500');
                }
            }

            function setupEventListeners() {
                els.btnSend.onclick = sendMessage;
                els.chatInput.oninput = function() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; };
                els.chatInput.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
                els.btnNewChat.onclick = createNewChat;
                els.btnThemeToggle.onclick = () => { state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark'; applyTheme(state.settings.theme); saveState(); };
                els.btnToggleSidebar.onclick = () => { els.sidebar.classList.toggle('-translate-x-full'); els.sidebarOverlay.classList.toggle('hidden'); };
                els.btnOpenSettings.onclick = () => { els.inputApiKey.value = state.settings.apiKey; els.inputModel.value = state.settings.model; els.settingsModal.classList.remove('hidden'); };
                els.btnOpenSystemPrompt.onclick = () => { els.inputSystemPrompt.value = state.systemPrompt; els.systemPromptModal.classList.remove('hidden'); };
                els.closeModalBtns.forEach(b => b.onclick = () => { els.settingsModal.classList.add('hidden'); els.systemPromptModal.classList.add('hidden'); });
                els.btnSaveSettings.onclick = () => {
                    state.settings.apiKey = els.inputApiKey.value;
                    state.settings.model = els.inputModel.value || state.settings.model;
                    els.currentModelDisplay.textContent = state.settings.model;
                    saveState();
                    els.settingsModal.classList.add('hidden');
                };
                els.btnSaveSystemPrompt.onclick = () => {
                    state.systemPrompt = els.inputSystemPrompt.value;
                    saveState();
                    els.systemPromptModal.classList.add('hidden');
                };
            }

            init();
        });
    </script>
</body>
</html>
